
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>sleap.nn.inference &#8212; SLEAP  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sleap.nn.inference</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class and command-line interface for running inference with trained models.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sub</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">sleap</span> <span class="kn">import</span> <span class="n">Labels</span><span class="p">,</span> <span class="n">LabeledFrame</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">job</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">model</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">utils</span>

<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">region_proposal</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">peak_finding</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">paf_grouping</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">topdown</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">tracking</span>

<span class="n">POLICY_CLASSES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">centroid</span><span class="o">=</span><span class="n">region_proposal</span><span class="o">.</span><span class="n">CentroidPredictor</span><span class="p">,</span>  <span class="c1"># requires model</span>
    <span class="n">region</span><span class="o">=</span><span class="n">region_proposal</span><span class="o">.</span><span class="n">RegionProposalExtractor</span><span class="p">,</span>  <span class="c1"># no model</span>
    <span class="n">topdown</span><span class="o">=</span><span class="n">topdown</span><span class="o">.</span><span class="n">TopDownPeakFinder</span><span class="p">,</span>  <span class="c1"># requires model</span>
    <span class="n">confmap</span><span class="o">=</span><span class="n">peak_finding</span><span class="o">.</span><span class="n">ConfmapPeakFinder</span><span class="p">,</span>  <span class="c1"># requires model</span>
    <span class="n">paf</span><span class="o">=</span><span class="n">paf_grouping</span><span class="o">.</span><span class="n">PAFGrouper</span><span class="p">,</span>  <span class="c1"># requires model</span>
<span class="p">)</span>


<div class="viewcode-block" id="Predictor"><a class="viewcode-back" href="../../../inference.html#sleap.nn.inference.Predictor">[docs]</a><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Predictor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encapsulates the inference pipeline.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        policies: A dictionary with objects for different parts of the pipeline:</span>

<span class="sd">          * &quot;centroid&quot;: Instance of `region_proposal.CentroidPredictor`</span>
<span class="sd">          * &quot;region&quot;: Instance of `region_proposal.RegionProposalExtractor`</span>
<span class="sd">          * &quot;confmap&quot;: Instance of `peak_finding.ConfmapPeakFinder`</span>
<span class="sd">          * &quot;paf&quot;: Instance of `paf_grouping.PAFGrouper`</span>
<span class="sd">          * &quot;tracking&quot;: Instance of `tracking.Tracker`</span>
<span class="sd">          * &quot;previous_predictions&quot;: `predicted.PredictedInstancePredictor`</span>

<span class="sd">    Note: the pipeline will be determined by which policies are given.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">policies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span>

    <span class="n">_tracker_takes_img</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__attrs_post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">inspect</span>

        <span class="k">if</span> <span class="s2">&quot;tracking&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="n">function_sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">track</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tracker_takes_img</span> <span class="o">=</span> <span class="s2">&quot;img&quot;</span> <span class="ow">in</span> <span class="n">function_sig</span><span class="o">.</span><span class="n">parameters</span>

<div class="viewcode-block" id="Predictor.predict"><a class="viewcode-back" href="../../../inference.html#sleap.nn.inference.Predictor.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">video_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">frames</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">video_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LabeledFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs entire inference pipeline on frames from a video file.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">video_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">video_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Detect whether to use grayscale video by looking at trained models.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_grayscale_models</span><span class="p">:</span>
            <span class="n">video_kwargs</span><span class="p">[</span><span class="s2">&quot;grayscale&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">is_dummy_video</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;tracking&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="ow">and</span> <span class="s2">&quot;previous_predictions&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">uses_image</span><span class="p">:</span>
                <span class="c1"># We&#39;re just running the tracker for previous predictions</span>
                <span class="c1"># and this tracker doesn&#39;t use the images, so we&#39;ll load</span>
                <span class="c1"># &quot;dummy&quot; images.</span>
                <span class="n">is_dummy_video</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">video_ds</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">VideoLoader</span><span class="p">(</span>
            <span class="n">filename</span><span class="o">=</span><span class="n">video_filename</span><span class="p">,</span>
            <span class="n">frame_inds</span><span class="o">=</span><span class="n">frames</span><span class="p">,</span>
            <span class="n">dummy</span><span class="o">=</span><span class="n">is_dummy_video</span><span class="p">,</span>
            <span class="o">**</span><span class="n">video_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">predicted_frames</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">chunk_ind</span><span class="p">,</span> <span class="n">frame_inds</span><span class="p">,</span> <span class="n">imgs</span> <span class="ow">in</span> <span class="n">video_ds</span><span class="p">:</span>

            <span class="n">predicted_instances_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_chunk</span><span class="p">(</span>
                <span class="n">imgs</span><span class="p">,</span> <span class="n">chunk_ind</span><span class="p">,</span> <span class="n">video_ds</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">frame_inds</span><span class="o">=</span><span class="n">frame_inds</span>
            <span class="p">)</span>

            <span class="n">sample_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">track_chunk</span><span class="p">(</span><span class="n">predicted_instances_chunk</span><span class="p">,</span> <span class="n">frame_inds</span><span class="p">,</span> <span class="n">sample_inds</span><span class="p">,</span> <span class="n">imgs</span><span class="p">)</span>

            <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_labeled_frames</span><span class="p">(</span>
                <span class="n">predicted_instances_chunk</span><span class="p">,</span> <span class="n">frame_inds</span><span class="p">,</span> <span class="n">sample_inds</span><span class="p">,</span> <span class="n">video_ds</span><span class="o">.</span><span class="n">video</span>
            <span class="p">)</span>

            <span class="n">predicted_frames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>

        <span class="c1"># Postprocessing after we&#39;ve finished all the chunks</span>

        <span class="k">if</span> <span class="s2">&quot;tracking&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">final_pass</span><span class="p">(</span><span class="n">frames</span><span class="o">=</span><span class="n">predicted_frames</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">predicted_frames</span></div>

<div class="viewcode-block" id="Predictor.predict_chunk"><a class="viewcode-back" href="../../../inference.html#sleap.nn.inference.Predictor.predict_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">predict_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_chunk</span><span class="p">,</span> <span class="n">chunk_ind</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">frame_inds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs the inference components of pipeline for a chunk.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;previous_predictions&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;previous_predictions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_chunk</span><span class="p">(</span><span class="n">frame_inds</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;centroid&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="c1"># Detect centroids and pull out region proposals.</span>
            <span class="n">centroid_predictor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;centroid&quot;</span><span class="p">]</span>
            <span class="n">region_proposal_extractor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span>

            <span class="n">centroids</span><span class="p">,</span> <span class="n">centroid_vals</span> <span class="o">=</span> <span class="n">centroid_predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img_chunk</span><span class="p">)</span>

            <span class="n">region_proposal_sets</span> <span class="o">=</span> <span class="n">region_proposal_extractor</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                <span class="n">img_chunk</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">centroid_vals</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We aren&#39;t using centroids, so use whole frame as region of interest.</span>
            <span class="n">region_proposal_sets</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">region_proposal</span><span class="o">.</span><span class="n">RegionProposalSet</span><span class="o">.</span><span class="n">from_uncropped</span><span class="p">(</span><span class="n">images</span><span class="o">=</span><span class="n">img_chunk</span><span class="p">)</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;paf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="c1"># If we don&#39;t have PAFs, we must be doing topdown or single-instance.</span>
            <span class="k">if</span> <span class="s2">&quot;topdown&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
                <span class="n">topdown_peak_finder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;topdown&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">topdown_peak_finder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;confmap&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region_proposal_sets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># No region proposals were found, so just return empty result.</span>
                <span class="k">return</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

            <span class="c1"># Only one scale region proposals in topdown inference.</span>
            <span class="n">rps</span> <span class="o">=</span> <span class="n">region_proposal_sets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Find peaks in each sample of the region proposal set.</span>
            <span class="n">sample_peak_pts</span><span class="p">,</span> <span class="n">sample_peak_vals</span> <span class="o">=</span> <span class="n">topdown_peak_finder</span><span class="o">.</span><span class="n">predict_rps</span><span class="p">(</span><span class="n">rps</span><span class="p">)</span>

            <span class="n">sample_peak_pts</span> <span class="o">=</span> <span class="n">sample_peak_pts</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="n">sample_peak_vals</span> <span class="o">=</span> <span class="n">sample_peak_vals</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="c1"># Gather instances across all region proposals for this chunk.</span>
            <span class="n">predicted_instances_chunk</span> <span class="o">=</span> <span class="n">topdown</span><span class="o">.</span><span class="n">make_sample_grouped_predicted_instances</span><span class="p">(</span>
                <span class="n">sample_peak_pts</span><span class="p">,</span>
                <span class="n">sample_peak_vals</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_peak_vals</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="n">topdown_peak_finder</span><span class="o">.</span><span class="n">inference_model</span><span class="o">.</span><span class="n">skeleton</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="s2">&quot;confmap&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span> <span class="ow">and</span> <span class="s2">&quot;paf&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="n">confmap_peak_finder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;confmap&quot;</span><span class="p">]</span>
            <span class="n">paf_grouper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;paf&quot;</span><span class="p">]</span>

            <span class="c1"># Find multi-instance peaks in each region proposal set.</span>
            <span class="n">region_peak_sets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rps</span> <span class="ow">in</span> <span class="n">region_proposal_sets</span><span class="p">:</span>
                <span class="n">region_peaks</span> <span class="o">=</span> <span class="n">confmap_peak_finder</span><span class="o">.</span><span class="n">predict_rps</span><span class="p">(</span><span class="n">rps</span><span class="p">)</span>
                <span class="n">region_peak_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_peaks</span><span class="p">)</span>

            <span class="c1"># Group peaks into instances using PAFs.</span>
            <span class="n">region_instance_sets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rps</span><span class="p">,</span> <span class="n">region_peaks</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">region_proposal_sets</span><span class="p">,</span> <span class="n">region_peak_sets</span><span class="p">):</span>
                <span class="n">region_instances</span> <span class="o">=</span> <span class="n">paf_grouper</span><span class="o">.</span><span class="n">predict_rps</span><span class="p">(</span><span class="n">rps</span><span class="p">,</span> <span class="n">region_peaks</span><span class="p">)</span>
                <span class="n">region_instance_sets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region_instances</span><span class="p">)</span>

            <span class="c1"># Gather instances across all region proposals for this chunk.</span>
            <span class="n">predicted_instances_chunk</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">region_instance_set</span> <span class="ow">in</span> <span class="n">region_instance_sets</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sample</span><span class="p">,</span> <span class="n">region_instances</span> <span class="ow">in</span> <span class="n">region_instance_set</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">predicted_instances_chunk</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">region_instances</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unable to run inference with {list(self.policies.keys())}&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">predicted_instances_chunk</span></div>

<div class="viewcode-block" id="Predictor.track_chunk"><a class="viewcode-back" href="../../../inference.html#sleap.nn.inference.Predictor.track_chunk">[docs]</a>    <span class="k">def</span> <span class="nf">track_chunk</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">predicted_instances_chunk</span><span class="p">,</span> <span class="n">frame_inds</span><span class="p">,</span> <span class="n">sample_inds</span><span class="p">,</span> <span class="n">img_chunk</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs tracker for each frame in chunk.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">frame_idx</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frame_inds</span><span class="p">,</span> <span class="n">sample_inds</span><span class="p">,</span> <span class="n">img_chunk</span><span class="p">):</span>
            <span class="n">frame_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">)</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">predicted_instances_chunk</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>

            <span class="n">predicted_instances_chunk</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_next_sample</span><span class="p">(</span>
                <span class="n">untracked_instances</span><span class="o">=</span><span class="n">instances</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">img</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Predictor.track_next_sample"><a class="viewcode-back" href="../../../inference.html#sleap.nn.inference.Predictor.track_next_sample">[docs]</a>    <span class="k">def</span> <span class="nf">track_next_sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">untracked_instances</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;PredictedInstance&quot;</span><span class="p">],</span> <span class="n">t</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;PredictedInstance&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Runs tracker for a single frame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;tracking&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">untracked_instances</span>

        <span class="n">tracker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span>

        <span class="n">track_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">untracked_instances</span><span class="o">=</span><span class="n">untracked_instances</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tracker_takes_img</span><span class="p">:</span>
            <span class="n">track_args</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">track_args</span><span class="p">[</span><span class="s2">&quot;img&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">tracker</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="o">**</span><span class="n">track_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="Predictor.make_labeled_frames"><a class="viewcode-back" href="../../../inference.html#sleap.nn.inference.Predictor.make_labeled_frames">[docs]</a>    <span class="k">def</span> <span class="nf">make_labeled_frames</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instances_chunk</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;PredictedInstance&quot;</span><span class="p">]],</span>
        <span class="n">frame_inds</span><span class="p">,</span>
        <span class="n">sample_inds</span><span class="p">,</span>
        <span class="n">video</span><span class="p">:</span> <span class="s2">&quot;Video&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LabeledFrame</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Makes LabeledFrame objects for all predictions in chunk.&quot;&quot;&quot;</span>

        <span class="n">sorted_instances_chunk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">instances_chunk</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="n">frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">frame_idx</span><span class="p">,</span> <span class="n">sample_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frame_inds</span><span class="p">,</span> <span class="n">sample_inds</span><span class="p">):</span>
            <span class="n">frame_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">frame_idx</span><span class="p">)</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">instances_chunk</span><span class="p">[</span><span class="n">sample_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">instances</span><span class="p">:</span>
                <span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">LabeledFrame</span><span class="p">(</span><span class="n">frame_idx</span><span class="o">=</span><span class="n">frame_idx</span><span class="p">,</span> <span class="n">instances</span><span class="o">=</span><span class="n">instances</span><span class="p">,</span> <span class="n">video</span><span class="o">=</span><span class="n">video</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">frames</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_grayscale_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">policy_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;topdown&quot;</span><span class="p">,</span> <span class="s2">&quot;confmap&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">policy_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">[</span><span class="n">policy_name</span><span class="p">]</span><span class="o">.</span><span class="n">inference_model</span><span class="o">.</span><span class="n">input_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="o">==</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cli_args</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">make_cli_parser</span><span class="p">()</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cli_args_to_policies</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">check_valid_policies</span><span class="p">(</span><span class="n">policies</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">policies</span><span class="o">=</span><span class="n">policies</span><span class="p">),</span> <span class="n">args</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_cli_parser</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>

        <span class="c1"># Helper functions for building parser</span>
        <span class="k">def</span> <span class="nf">add_class_args</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">attrs_class</span><span class="p">,</span> <span class="n">arg_scope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exclude_args</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">is_arg_to_include</span><span class="p">(</span><span class="n">arg_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">arg_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">arg_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_model&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">exclude_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">arg_scope</span> <span class="ow">in</span> <span class="n">exclude_args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arg_name</span> <span class="ow">in</span> <span class="n">exclude_args</span><span class="p">[</span><span class="n">arg_scope</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">return</span> <span class="kc">True</span>

            <span class="k">def</span> <span class="nf">arg_docstring</span><span class="p">(</span><span class="n">attrs_class</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">):</span>
                <span class="c1"># TODO: parse docstring and return text for this attribute</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span>

            <span class="k">for</span> <span class="n">attrib</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="n">attrs_class</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">is_arg_to_include</span><span class="p">(</span><span class="n">attrib</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">help_string</span> <span class="o">=</span> <span class="n">arg_docstring</span><span class="p">(</span><span class="n">attrs_class</span><span class="p">,</span> <span class="n">attrib</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attrib</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">NOTHING</span><span class="p">:</span>
                        <span class="n">help_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (default: </span><span class="si">{attrib.default}</span><span class="s2">)&quot;</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{arg_scope}</span><span class="s2">.</span><span class="si">{attrib.name}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">attrib</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="n">help_string</span><span class="p">,</span>
                    <span class="p">)</span>

        <span class="k">def</span> <span class="nf">frame_list</span><span class="p">(</span><span class="n">frame_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>

            <span class="c1"># Handle ranges of frames.</span>
            <span class="c1"># NOTE: Ranges are *inclusive* at both ends.</span>
            <span class="c1"># Must be in format &quot;123-456&quot; or &quot;5,-10&quot; (i.e., 5-10),</span>
            <span class="c1"># and doesn&#39;t support list of ranges.</span>
            <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">frame_str</span><span class="p">:</span>
                <span class="n">min_max</span> <span class="o">=</span> <span class="n">frame_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="n">min_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
                <span class="n">max_frame</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_frame</span><span class="p">,</span> <span class="n">max_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">frame_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_str</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Make the parser</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>

        <span class="c1"># Add args for entire pipeline</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;data_path&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to video file&quot;</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--model&quot;</span><span class="p">,</span>
            <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;models&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to saved model (confmaps, pafs, ...) JSON. &quot;</span>
            <span class="s2">&quot;Multiple models can be specified, each preceded by --model.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--frames&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">frame_list</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;List of frames to predict. Either comma separated list (e.g. 1,2,3) or &quot;</span>
            <span class="s2">&quot;a range separated by hyphen (e.g. 1-3, for 1,2,3). (default is entire video)&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The output filename to use for the predicted data.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># TODO: better video parameters</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video.dataset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The dataset for HDF5 videos.&quot;</span>
        <span class="p">)</span>

        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video.input_format&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The input_format for HDF5 videos.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Class attributes to exclude from cli</span>
        <span class="n">exclude_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;merge_overlapping&quot;</span><span class="p">,))</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs_class</span> <span class="ow">in</span> <span class="n">POLICY_CLASSES</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">add_class_args</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">attrs_class</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">exclude_args</span><span class="p">)</span>

        <span class="n">tracking</span><span class="o">.</span><span class="n">Tracker</span><span class="o">.</span><span class="n">add_cli_parser_args</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">arg_scope</span><span class="o">=</span><span class="s2">&quot;tracking&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">cli_args_to_policies</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">policy_args</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">make_scoped_dictionary</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">exclude_nones</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_paths_and_policy_args</span><span class="p">(</span>
            <span class="n">model_paths</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="n">policy_args</span><span class="o">=</span><span class="n">policy_args</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_paths_and_policy_args</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">model_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">policy_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="nb">dict</span>
    <span class="p">):</span>
        <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">][</span><span class="s2">&quot;merge_overlapping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">inferred_box_length</span> <span class="o">=</span> <span class="mi">160</span>  <span class="c1"># default if not set by user or inferrable</span>

        <span class="n">policies</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">model_type_policy_key_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">CONFIDENCE_MAP</span><span class="p">:</span> <span class="s2">&quot;confmap&quot;</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">PART_AFFINITY_FIELD</span><span class="p">:</span> <span class="s2">&quot;paf&quot;</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">CENTROIDS</span><span class="p">:</span> <span class="s2">&quot;centroid&quot;</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">TOPDOWN_CONFIDENCE_MAP</span><span class="p">:</span> <span class="s2">&quot;topdown&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Load the information for these models</span>
        <span class="n">loaded_models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">model_paths</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">model_path</span> <span class="ow">in</span> <span class="n">model_paths</span><span class="p">:</span>
                <span class="n">training_job</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">TrainingJob</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
                <span class="n">inference_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">InferenceModel</span><span class="o">.</span><span class="n">from_training_job</span><span class="p">(</span><span class="n">training_job</span><span class="p">)</span>
                <span class="n">policy_key</span> <span class="o">=</span> <span class="n">model_type_policy_key_map</span><span class="p">[</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_type</span><span class="p">]</span>

                <span class="n">loaded_models</span><span class="p">[</span><span class="n">policy_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">job</span><span class="o">=</span><span class="n">training_job</span><span class="p">,</span> <span class="n">inference_model</span><span class="o">=</span><span class="n">inference_model</span>
                <span class="p">)</span>

            <span class="c1"># Add policy classes which depend on models</span>
            <span class="k">for</span> <span class="n">policy_key</span><span class="p">,</span> <span class="n">policy_model</span> <span class="ow">in</span> <span class="n">loaded_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">training_job</span> <span class="o">=</span> <span class="n">policy_model</span><span class="p">[</span><span class="s2">&quot;job&quot;</span><span class="p">]</span>
                <span class="n">inference_model</span> <span class="o">=</span> <span class="n">policy_model</span><span class="p">[</span><span class="s2">&quot;inference_model&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">policy_key</span> <span class="o">==</span> <span class="s2">&quot;confmap&quot;</span> <span class="ow">and</span> <span class="s2">&quot;paf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loaded_models</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># Use topdown class when we have confmaps and not pafs</span>
                    <span class="n">policy_class</span> <span class="o">=</span> <span class="n">POLICY_CLASSES</span><span class="p">[</span><span class="s2">&quot;topdown&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">policy_class</span> <span class="o">=</span> <span class="n">POLICY_CLASSES</span><span class="p">[</span><span class="n">policy_key</span><span class="p">]</span>

                <span class="n">policy_object</span> <span class="o">=</span> <span class="n">policy_class</span><span class="p">(</span>
                    <span class="n">inference_model</span><span class="o">=</span><span class="n">inference_model</span><span class="p">,</span> <span class="o">**</span><span class="n">policy_args</span><span class="p">[</span><span class="n">policy_key</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">policies</span><span class="p">[</span><span class="n">policy_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_object</span>

                <span class="k">if</span> <span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">inferred_box_length</span> <span class="o">=</span> <span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span>

        <span class="c1"># No models specified so see if we&#39;re using previous predictions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">previous_labels</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">video_callback</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">)],</span>
                <span class="p">)</span>
                <span class="kn">from</span> <span class="nn">.predicted</span> <span class="kn">import</span> <span class="n">PredictedInstancePredictor</span>

                <span class="n">policies</span><span class="p">[</span><span class="s2">&quot;previous_predictions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PredictedInstancePredictor</span><span class="p">(</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">previous_labels</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using previous predictions from </span><span class="si">{args.data_path}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">previous_labels</span><span class="o">.</span><span class="n">videos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting video to </span><span class="si">{args.data_path}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># We weren&#39;t able to read file as Labels object</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="s2">&quot;topdown&quot;</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">][</span><span class="s2">&quot;merge_overlapping&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;instance_box_length&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]:</span>
            <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">][</span><span class="s2">&quot;instance_box_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inferred_box_length</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;merged_box_length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">][</span><span class="s2">&quot;merged_box_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">][</span><span class="s2">&quot;instance_box_length&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="p">)</span>

        <span class="c1"># Add non-model policy classes</span>
        <span class="n">non_model_policy_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">POLICY_CLASSES</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_type_policy_key_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">non_model_policy_keys</span><span class="p">:</span>
            <span class="n">policies</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">POLICY_CLASSES</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="o">**</span><span class="n">policy_args</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">tracker_name</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;tracking&quot;</span> <span class="ow">in</span> <span class="n">policy_args</span><span class="p">:</span>
            <span class="n">tracker_name</span> <span class="o">=</span> <span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tracker&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tracker_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">policies</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracking</span><span class="o">.</span><span class="n">Tracker</span><span class="o">.</span><span class="n">make_tracker_by_name</span><span class="p">(</span>
                <span class="o">**</span><span class="n">policy_args</span><span class="p">[</span><span class="s2">&quot;tracking&quot;</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">policies</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">predict_subprocess</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">video</span><span class="p">:</span> <span class="s2">&quot;Video&quot;</span><span class="p">,</span>
        <span class="n">trained_job_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">frames</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">waiting_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels_filename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">cli_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;sleap.nn.inference&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">trained_job_paths</span> <span class="ow">and</span> <span class="s2">&quot;tracking.tracker&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">labels_filename</span><span class="p">:</span>
            <span class="c1"># No models so we must want to re-track previous predictions</span>
            <span class="n">cli_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cli_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># TODO: better support for video params</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">):</span>
            <span class="n">cli_args</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;--video.dataset&quot;</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">dataset</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">video</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="s2">&quot;input_format&quot;</span><span class="p">):</span>
            <span class="n">cli_args</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;--video.input_format&quot;</span><span class="p">,</span> <span class="n">video</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">input_format</span><span class="p">))</span>

        <span class="c1"># Make path where we&#39;ll save predictions</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">video</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">),</span>
                <span class="s2">&quot;predictions.h5&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">job_path</span> <span class="ow">in</span> <span class="n">trained_job_paths</span><span class="p">:</span>
            <span class="n">cli_args</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="n">job_path</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="n">cli_args</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{key}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>

        <span class="n">cli_args</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;--frames&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">frames</span><span class="p">))))</span>

        <span class="n">cli_args</span><span class="o">.</span><span class="n">extend</span><span class="p">((</span><span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">output_path</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Command line call:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; </span><span class="se">\\\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cli_args</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">sub</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cli_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">waiting_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">waiting_callback</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># -1 signals user cancellation</span>
                        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">False</span>

                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Process return code: </span><span class="si">{proc.returncode}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">success</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">check_valid_policies</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">policies</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>

        <span class="n">has_topdown</span> <span class="o">=</span> <span class="s2">&quot;topdown&quot;</span> <span class="ow">in</span> <span class="n">policies</span>
        <span class="n">has_previous</span> <span class="o">=</span> <span class="s2">&quot;previous_predictions&quot;</span> <span class="ow">in</span> <span class="n">policies</span>
        <span class="n">has_tracker</span> <span class="o">=</span> <span class="s2">&quot;tracking&quot;</span> <span class="ow">in</span> <span class="n">policies</span>
        <span class="n">non_topdowns</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">policies</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;confmap&quot;</span><span class="p">,</span> <span class="s2">&quot;paf&quot;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">has_previous</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_tracker</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;No tracker specified for running on previous predictions&quot;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">has_topdown</span> <span class="ow">and</span> <span class="n">non_topdowns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Cannot combine topdown model with non-topdown model&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{non_topdowns}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">non_topdowns</span> <span class="ow">and</span> <span class="s2">&quot;confmap&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_topdowns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must have CONFIDENCE_MAP model.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_topdown</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">non_topdowns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Must have either TOPDOWN or CONFIDENCE_MAP/PART_AFFINITY_FIELD models.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../inference.html#sleap.nn.inference.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;CLI for running inference.&quot;&quot;&quot;</span>
    <span class="n">predictor</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">Predictor</span><span class="o">.</span><span class="n">from_cli_args</span><span class="p">()</span>

    <span class="c1"># TODO: better support for video params</span>
    <span class="n">video_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">dataset</span><span class="o">=</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;video.dataset&quot;</span><span class="p">),</span>
        <span class="n">input_format</span><span class="o">=</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;video.input_format&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">lfs</span> <span class="o">=</span> <span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">video_filename</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">frames</span><span class="p">,</span> <span class="n">video_kwargs</span><span class="o">=</span><span class="n">video_kwargs</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.predictions.h5&quot;</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">out_name</span><span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">Labels</span><span class="p">(</span><span class="n">labeled_frames</span><span class="o">=</span><span class="n">lfs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving: </span><span class="si">{output_path}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">Labels</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">output_path</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">SLEAP</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial-part2.html">Tutorial, Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../howtos.html">How-Tos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Feature Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Murthy Lab @ Princeton.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>