
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>sleap.nn.training &#8212; SLEAP  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sleap.nn.training</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;SLEAP model training.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">sleap</span> <span class="kn">import</span> <span class="n">Labels</span><span class="p">,</span> <span class="n">Skeleton</span>
<span class="kn">from</span> <span class="nn">sleap.util</span> <span class="kn">import</span> <span class="n">get_package_file</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">callbacks</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">data</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">job</span>
<span class="kn">from</span> <span class="nn">sleap.nn</span> <span class="kn">import</span> <span class="n">model</span>


<span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Trainer</span><span class="p">:</span>
    <span class="n">training_job</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">TrainingJob</span>

    <span class="n">tensorboard</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tensorboard_freq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;epoch&quot;</span>
    <span class="n">tensorboard_dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Text</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tensorboard_profiling</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">zmq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">control_zmq_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9000</span>
    <span class="n">progress_report_zmq_port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">9001</span>
    <span class="n">verbosity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">_img_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_n_output_channels</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_train</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_val</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_test</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_ds_train</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_ds_val</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_ds_test</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_simple_skeleton</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">SimpleSkeleton</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_model</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_optimizer</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Optimizer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_loss_fn</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">Loss</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_training_callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_history</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">img_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_img_shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_output_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_output_channels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ds_train</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds_train</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ds_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds_val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ds_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ds_test</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">simple_skeleton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_skeleton</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loss_fn</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">training_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_callbacks</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_history</span>

    <span class="k">def</span> <span class="nf">setup_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">train</span> <span class="o">=</span> <span class="n">labels_train</span>
        <span class="k">if</span> <span class="n">train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">train_set_filename</span>
        <span class="k">if</span> <span class="n">train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading labels: </span><span class="si">{train}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="o">.</span><span class="n">from_labels</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">data_train</span>
        <span class="k">if</span> <span class="n">train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data: </span><span class="si">{train}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">train</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Training data was not specified.&quot;</span><span class="p">)</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">labels_val</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">val_set_filename</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading labels: </span><span class="si">{val}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="o">.</span><span class="n">from_labels</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data_val</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data: </span><span class="si">{val}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">val_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split_training_data</span><span class="p">(</span>
                <span class="n">train</span><span class="p">,</span> <span class="n">first_split_fraction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">val_size</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Validation set or fraction must be specified.&quot;</span><span class="p">)</span>

        <span class="n">test</span> <span class="o">=</span> <span class="n">labels_test</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">test_set_filename</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading labels: </span><span class="si">{test}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="o">.</span><span class="n">from_labels</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">data_test</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading data: </span><span class="si">{test}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

        <span class="c1"># Setup initial zipped datasets.</span>
        <span class="n">ds_train</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">to_ds</span><span class="p">()</span>
        <span class="n">ds_val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">to_ds</span><span class="p">()</span>
        <span class="n">ds_test</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_test</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">to_ds</span><span class="p">()</span>

        <span class="c1"># Adjust for input scaling and add padding to the model&#39;s minimum multiple.</span>
        <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">adjust_dataset_input_scale</span><span class="p">(</span>
            <span class="n">ds_train</span><span class="p">,</span>
            <span class="n">input_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">input_scale</span><span class="p">,</span>
            <span class="n">min_multiple</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_min_multiple</span><span class="p">,</span>
            <span class="n">normalize_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">adjust_dataset_input_scale</span><span class="p">(</span>
            <span class="n">ds_val</span><span class="p">,</span>
            <span class="n">input_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">input_scale</span><span class="p">,</span>
            <span class="n">min_multiple</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_min_multiple</span><span class="p">,</span>
            <span class="n">normalize_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">adjust_dataset_input_scale</span><span class="p">(</span>
                <span class="n">ds_test</span><span class="p">,</span>
                <span class="n">input_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">input_scale</span><span class="p">,</span>
                <span class="n">min_multiple</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_min_multiple</span><span class="p">,</span>
                <span class="n">normalize_image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Cache the data with the current transformations.</span>
        <span class="c1"># ds_train = ds_train.cache()</span>
        <span class="c1"># ds_val = ds_val.cache()</span>
        <span class="c1"># if ds_test is not None:</span>
        <span class="c1">#     ds_test = ds_test.cache()</span>

        <span class="c1"># Apply augmentations.</span>
        <span class="n">aug_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">rotate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_rotate</span><span class="p">,</span>
            <span class="n">rotation_min_angle</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_rotation</span><span class="p">,</span>
            <span class="n">rotation_max_angle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_rotation</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_scale</span><span class="p">,</span>
            <span class="n">scale_min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_scale_min</span><span class="p">,</span>
            <span class="n">scale_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_scale_max</span><span class="p">,</span>
            <span class="n">uniform_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_uniform_noise</span><span class="p">,</span>
            <span class="n">min_noise_val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_uniform_noise_min_val</span><span class="p">,</span>
            <span class="n">max_noise_val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_uniform_noise_max_val</span><span class="p">,</span>
            <span class="n">gaussian_noise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_gaussian_noise</span><span class="p">,</span>
            <span class="n">gaussian_noise_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_gaussian_noise_mean</span><span class="p">,</span>
            <span class="n">gaussian_noise_stddev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">augment_gaussian_noise_stddev</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">augment_dataset</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="o">**</span><span class="n">aug_params</span><span class="p">)</span>
        <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">augment_dataset</span><span class="p">(</span><span class="n">ds_val</span><span class="p">,</span> <span class="o">**</span><span class="n">aug_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">instance_crop</span><span class="p">:</span>
            <span class="c1"># Crop around instances.</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span> <span class="o">&lt;=</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="c1"># Estimate bounding box size from the data if not specified.</span>
                <span class="c1"># TODO: Do this earlier with more points if available.</span>
                <span class="n">box_size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">estimate_instance_crop_size</span><span class="p">(</span>
                    <span class="n">train</span><span class="o">.</span><span class="n">points</span><span class="p">,</span>
                    <span class="n">min_multiple</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">input_min_multiple</span><span class="p">,</span>
                    <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">instance_crop_padding</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span> <span class="o">=</span> <span class="n">box_size</span>

            <span class="n">crop_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">box_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span><span class="p">,</span>
                <span class="n">box_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">bounding_box_size</span><span class="p">,</span>
                <span class="n">use_ctr_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">instance_crop_use_ctr_node</span><span class="p">,</span>
                <span class="n">ctr_node_ind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">instance_crop_ctr_node_ind</span><span class="p">,</span>
                <span class="n">normalize_image</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">instance_crop_dataset</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="o">**</span><span class="n">crop_params</span><span class="p">)</span>
            <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">instance_crop_dataset</span><span class="p">(</span><span class="n">ds_val</span><span class="p">,</span> <span class="o">**</span><span class="n">crop_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">instance_crop_dataset</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="o">**</span><span class="n">crop_params</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We&#39;re not instance cropping, so at this point the images are still not</span>
            <span class="c1"># normalized. Let&#39;s account for that before moving on.</span>
            <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">normalize_dataset</span><span class="p">(</span><span class="n">ds_train</span><span class="p">)</span>
            <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">normalize_dataset</span><span class="p">(</span><span class="n">ds_val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">normalize_dataset</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span>

        <span class="c1"># Setup remaining pipeline by output type.</span>
        <span class="c1"># rel_output_scale = (</span>
        <span class="c1"># self.training_job.model.output_scale / self.training_job.input_scale</span>
        <span class="c1"># )</span>
        <span class="c1"># TODO: Update this to the commented calculation above when model config</span>
        <span class="c1"># includes metadata about absolute input scale.</span>
        <span class="n">rel_output_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_scale</span>
        <span class="n">output_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_type</span>
        <span class="k">if</span> <span class="n">output_type</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">CONFIDENCE_MAP</span><span class="p">:</span>
            <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_confmap_dataset</span><span class="p">(</span>
                <span class="n">ds_train</span><span class="p">,</span>
                <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_confmap_dataset</span><span class="p">(</span>
                <span class="n">ds_val</span><span class="p">,</span>
                <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_confmap_dataset</span><span class="p">(</span>
                    <span class="n">ds_test</span><span class="p">,</span>
                    <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                    <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">n_output_channels</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">skeleton</span><span class="o">.</span><span class="n">n_nodes</span>

        <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">TOPDOWN_CONFIDENCE_MAP</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">instance_crop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot train a topddown model without instance cropping enabled.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># TODO: Parametrize multiple heads in the training configuration.</span>
            <span class="n">cm_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
                <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                <span class="n">with_instance_cms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">with_all_peaks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">with_ctr_peaks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_instance_confmap_dataset</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="o">**</span><span class="n">cm_params</span><span class="p">)</span>
            <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_instance_confmap_dataset</span><span class="p">(</span><span class="n">ds_val</span><span class="p">,</span> <span class="o">**</span><span class="n">cm_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_instance_confmap_dataset</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="o">**</span><span class="n">cm_params</span><span class="p">)</span>
            <span class="n">n_output_channels</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">skeleton</span><span class="o">.</span><span class="n">n_nodes</span>

        <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">PART_AFFINITY_FIELD</span><span class="p">:</span>
            <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_paf_dataset</span><span class="p">(</span>
                <span class="n">ds_train</span><span class="p">,</span>
                <span class="n">train</span><span class="o">.</span><span class="n">skeleton</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>
                <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                <span class="n">distance_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_paf_dataset</span><span class="p">(</span>
                <span class="n">ds_val</span><span class="p">,</span>
                <span class="n">train</span><span class="o">.</span><span class="n">skeleton</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>
                <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                <span class="n">distance_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_paf_dataset</span><span class="p">(</span>
                    <span class="n">ds_test</span><span class="p">,</span>
                    <span class="n">train</span><span class="o">.</span><span class="n">skeleton</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span>
                    <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                    <span class="n">distance_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">n_output_channels</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">skeleton</span><span class="o">.</span><span class="n">n_edges</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="k">elif</span> <span class="n">output_type</span> <span class="o">==</span> <span class="n">model</span><span class="o">.</span><span class="n">ModelOutputType</span><span class="o">.</span><span class="n">CENTROIDS</span><span class="p">:</span>
            <span class="n">cm_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">sigma</span><span class="p">,</span>
                <span class="n">output_scale</span><span class="o">=</span><span class="n">rel_output_scale</span><span class="p">,</span>
                <span class="n">use_ctr_node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">instance_crop_use_ctr_node</span><span class="p">,</span>
                <span class="n">ctr_node_ind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">instance_crop_ctr_node_ind</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">ds_train</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_centroid_confmap_dataset</span><span class="p">(</span><span class="n">ds_train</span><span class="p">,</span> <span class="o">**</span><span class="n">cm_params</span><span class="p">)</span>
            <span class="n">ds_val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_centroid_confmap_dataset</span><span class="p">(</span><span class="n">ds_val</span><span class="p">,</span> <span class="o">**</span><span class="n">cm_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ds_test</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">make_centroid_confmap_dataset</span><span class="p">(</span><span class="n">ds_test</span><span class="p">,</span> <span class="o">**</span><span class="n">cm_params</span><span class="p">)</span>

            <span class="n">n_output_channels</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid model output type specified (</span><span class="si">{self.training_job.model.output_type}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">batch_size</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">val_steps_per_epoch</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">val_steps_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Set up shuffling, batching, repeating and prefetching.</span>
        <span class="n">shuffle_buffer_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">shuffle_buffer_size</span>
        <span class="k">if</span> <span class="n">shuffle_buffer_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">shuffle_buffer_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shuffle_buffer_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
        <span class="n">ds_train</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ds_train</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffle_buffer_size</span><span class="p">)</span>
            <span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">)</span>
            <span class="c1"># .prefetch(buffer_size=tf.data.experimental.AUTOTUNE)</span>
        <span class="p">)</span>
        <span class="n">ds_val</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ds_val</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
            <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">buffer_size</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">ds_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ds_test</span> <span class="o">=</span> <span class="n">ds_val</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span>
                <span class="n">buffer_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">val_steps_per_epoch</span>
                <span class="c1"># buffer_size=tf.data.experimental.AUTOTUNE</span>
            <span class="p">)</span>

        <span class="c1"># Get image shape after all the dataset transformations are applied.</span>
        <span class="n">img_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ds_val</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Update internal attributes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_img_shape</span> <span class="o">=</span> <span class="n">img_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_output_channels</span> <span class="o">=</span> <span class="n">n_output_channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_train</span> <span class="o">=</span> <span class="n">train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test</span> <span class="o">=</span> <span class="n">test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_train</span> <span class="o">=</span> <span class="n">ds_train</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_val</span> <span class="o">=</span> <span class="n">ds_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ds_test</span> <span class="o">=</span> <span class="n">ds_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simple_skeleton</span> <span class="o">=</span> <span class="n">train</span><span class="o">.</span><span class="n">skeleton</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">skeletons</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">skeletons</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="c1"># Save skeleton to training job/model config if none were already stored.</span>
            <span class="n">skeleton</span> <span class="o">=</span> <span class="n">Skeleton</span><span class="o">.</span><span class="n">from_names_and_edge_inds</span><span class="p">(</span>
                <span class="n">node_names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simple_skeleton</span><span class="o">.</span><span class="n">node_names</span><span class="p">,</span>
                <span class="n">edge_inds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simple_skeleton</span><span class="o">.</span><span class="n">edge_inds</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">skeletons</span> <span class="o">=</span> <span class="p">[</span><span class="n">skeleton</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Input scale:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">input_scale</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Relative output scale:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_scale</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;  Output scale:&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">input_scale</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_scale</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Training data:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_train</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Validation data:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_val</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Test data:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_test</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Test data: N/A&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Image shape:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Output channels:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_output_channels</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Skeleton:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simple_skeleton</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ds_train</span><span class="p">,</span> <span class="n">ds_val</span><span class="p">,</span> <span class="n">ds_test</span>

    <span class="k">def</span> <span class="nf">setup_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">]:</span>

        <span class="n">callback_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">reduce_lr_on_plateau</span><span class="p">:</span>
            <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">callbacks</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
                    <span class="n">min_delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">reduce_lr_min_delta</span><span class="p">,</span>
                    <span class="n">factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">reduce_lr_factor</span><span class="p">,</span>
                    <span class="n">patience</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">reduce_lr_patience</span><span class="p">,</span>
                    <span class="n">cooldown</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">reduce_lr_cooldown</span><span class="p">,</span>
                    <span class="n">min_lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">reduce_lr_min_lr</span><span class="p">,</span>
                    <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">monitor_metric_name</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stopping</span><span class="p">:</span>
            <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">callbacks</span><span class="o">.</span><span class="n">EarlyStopping</span><span class="p">(</span>
                    <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">monitor_metric_name</span><span class="p">,</span>
                    <span class="n">min_delta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stopping_min_delta</span><span class="p">,</span>
                    <span class="n">patience</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">early_stopping_patience</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">csv_logging</span><span class="p">:</span>
                <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">CSVLogger</span><span class="p">(</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">csv_log_filename</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span>
                <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">TensorBoard</span><span class="p">(</span>
                        <span class="n">log_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorboard_dir</span><span class="p">,</span>
                        <span class="n">update_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tensorboard_freq</span><span class="p">,</span>
                        <span class="n">profile_batch</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensorboard_profiling</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">save_every_epoch</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">newest_model_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">newest_model_filename</span> <span class="o">=</span> <span class="s2">&quot;newest_model.h5&quot;</span>

                <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
                        <span class="n">filepath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">newest_model_filename</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">monitor_metric_name</span><span class="p">,</span>
                        <span class="n">save_best_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_freq</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">save_best_val</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">best_model_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">best_model_filename</span> <span class="o">=</span> <span class="s2">&quot;best_model.h5&quot;</span>

                <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpoint</span><span class="p">(</span>
                        <span class="n">filepath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">best_model_filename</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">monitor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">monitor_metric_name</span><span class="p">,</span>
                        <span class="n">save_best_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">save_weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">save_freq</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">save_final_model</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">final_model_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">final_model_filename</span> <span class="o">=</span> <span class="s2">&quot;final_model.h5&quot;</span>

                <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">ModelCheckpointOnEvent</span><span class="p">(</span>
                        <span class="n">filepath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">final_model_filename</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">event</span><span class="o">=</span><span class="s2">&quot;train_end&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">save</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">,</span> <span class="s2">&quot;training_job.json&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmq</span><span class="p">:</span>
            <span class="c1"># Callbacks: ZMQ control</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_zmq_port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">TrainingControllerZMQ</span><span class="p">(</span>
                        <span class="n">address</span><span class="o">=</span><span class="s2">&quot;tcp://127.0.0.1&quot;</span><span class="p">,</span>
                        <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_zmq_port</span><span class="p">,</span>
                        <span class="n">topic</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">poll_timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># Callbacks: ZMQ progress reporter</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_report_zmq_port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">callback_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">callbacks</span><span class="o">.</span><span class="n">ProgressReporterZMQ</span><span class="p">(</span>
                        <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">progress_report_zmq_port</span><span class="p">,</span>
                        <span class="n">what</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output_type</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_training_callbacks</span> <span class="o">=</span> <span class="n">callback_list</span>
        <span class="k">return</span> <span class="n">callback_list</span>

    <span class="k">def</span> <span class="nf">setup_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;adam&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                <span class="n">amsgrad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">amsgrad</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;rmsprop&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
                <span class="n">learning_rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">learning_rate</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Unrecognized optimizer specified: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimizer</span> <span class="o">=</span> <span class="n">optimizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loss_fn</span> <span class="o">=</span> <span class="n">loss_fn</span>

        <span class="k">return</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">loss_fn</span>

    <span class="k">def</span> <span class="nf">setup_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_output_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">img_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_shape</span>

        <span class="k">if</span> <span class="n">n_output_channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_output_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_output_channels</span>

        <span class="n">input_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">input_layer</span><span class="p">,</span> <span class="n">n_output_channels</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">outputs</span>

        <span class="n">keras_model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">input_layer</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">backbone_name</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{keras_model.name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Input: </span><span class="si">{keras_model.input_shape}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Output: </span><span class="si">{keras_model.output_shape}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Layers: {len(keras_model.layers)}&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Params: {keras_model.count_params():3,}&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">keras_model</span>

        <span class="k">return</span> <span class="n">keras_model</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">labels_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">labels_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Labels</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_train</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_test</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">TrainingData</span><span class="p">,</span> <span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_callbacks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">Callback</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_data</span><span class="p">(</span>
            <span class="n">labels_train</span><span class="o">=</span><span class="n">labels_train</span><span class="p">,</span>
            <span class="n">labels_val</span><span class="o">=</span><span class="n">labels_val</span><span class="p">,</span>
            <span class="n">labels_test</span><span class="o">=</span><span class="n">labels_test</span><span class="p">,</span>
            <span class="n">data_train</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
            <span class="n">data_val</span><span class="o">=</span><span class="n">data_val</span><span class="p">,</span>
            <span class="n">data_test</span><span class="o">=</span><span class="n">data_test</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_optimization</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_name</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="c1"># Generate new run name if save_dir specified but not the run name.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">new_run_name</span><span class="p">(</span>
                <span class="n">suffix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;n={len(self.data_train.images)}&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run path: </span><span class="si">{self.training_job.run_path}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run path: Not provided, nothing will be saved to disk.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_callbacks</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">extra_callbacks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">training_callbacks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_callbacks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">)</span>

        <span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training started: {str(t0)}&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ds_train</span><span class="p">,</span>
            <span class="n">epochs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span>
            <span class="n">callbacks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_callbacks</span><span class="p">,</span>
            <span class="n">validation_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ds_val</span><span class="p">,</span>
            <span class="n">steps_per_epoch</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">steps_per_epoch</span><span class="p">,</span>
            <span class="n">validation_steps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">training_job</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">val_steps_per_epoch</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training finished: {str(t1)}&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total runtime: {str(elapsed)}&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: Evaluate final test set performance if available</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">train_subprocess</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">training_job</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">TrainingJob</span><span class="p">,</span>
        <span class="n">labels_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">waiting_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs training inside subprocess.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sub</span>
        <span class="kn">import</span> <span class="nn">time</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>

        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>

            <span class="c1"># Write a temporary file of the TrainingJob so that we can respect</span>
            <span class="c1"># any changed made to the job attributes after it was loaded.</span>
            <span class="n">temp_filename</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_training_job.json&quot;</span>
            <span class="p">)</span>
            <span class="n">training_job_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">)</span>

            <span class="n">training_job</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">labels_filename</span><span class="p">),</span> <span class="s2">&quot;models&quot;</span>
            <span class="p">)</span>

            <span class="n">run_name</span> <span class="o">=</span> <span class="n">training_job</span><span class="o">.</span><span class="n">new_run_name</span><span class="p">(</span><span class="n">check_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">run_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">training_job</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">training_job</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">TrainingJob</span><span class="o">.</span><span class="n">save_json</span><span class="p">(</span><span class="n">training_job</span><span class="p">,</span> <span class="n">training_job_path</span><span class="p">)</span>

            <span class="c1"># Build CLI arguments for training</span>
            <span class="n">cli_args</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sleap.nn.training&quot;</span><span class="p">,</span>
                <span class="n">training_job_path</span><span class="p">,</span>
                <span class="n">labels_filename</span><span class="p">,</span>
                <span class="s2">&quot;--zmq&quot;</span><span class="p">,</span>
                <span class="s2">&quot;--run_name&quot;</span><span class="p">,</span>
                <span class="n">run_name</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">cli_args</span><span class="p">)</span>

            <span class="c1"># Run training in a subprocess</span>
            <span class="c1"># with sub.Popen(cli_args, stdout=sub.PIPE) as proc:</span>
            <span class="k">with</span> <span class="n">sub</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cli_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>

                <span class="c1"># Wait till training is done, calling a callback if given.</span>
                <span class="k">while</span> <span class="n">proc</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">waiting_callback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">waiting_callback</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># -1 signals user cancellation</span>
                            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">False</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

                <span class="n">success</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">run_path</span><span class="p">,</span> <span class="n">success</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../training.html#sleap.nn.training.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;CLI for training.&quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;training_job_path&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to training job profile JSON file.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;labels_path&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to labels file to use for training.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--val_labels&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--val&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to labels file to use for validation (overrides training job path if set).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--test_labels&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--test&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to labels file to use for test (overrides training job path if set).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--tensorboard&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enables TensorBoard logging to the run path.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--zmq&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enables ZMQ logging (for GUI).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--run_name&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run name to use when saving file, overrides other run name settings.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--prefix&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Prefix to prepend to run name. Can be specified multiple times.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--suffix&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Suffix to append to run name. Can be specified multiple times.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="n">job_filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">training_job_path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">job_filename</span><span class="p">):</span>
        <span class="n">profile_dir</span> <span class="o">=</span> <span class="n">get_package_file</span><span class="p">(</span><span class="s2">&quot;sleap/training_profiles&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profile_dir</span><span class="p">,</span> <span class="n">job_filename</span><span class="p">)):</span>
            <span class="n">job_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">profile_dir</span><span class="p">,</span> <span class="n">job_filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find training profile: </span><span class="si">{job_filename}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">labels_train_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">labels_path</span>

    <span class="n">training_job</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">TrainingJob</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="n">job_filename</span><span class="p">)</span>

    <span class="c1"># Set data paths in job.</span>
    <span class="n">training_job</span><span class="o">.</span><span class="n">labels_filename</span> <span class="o">=</span> <span class="n">labels_train_path</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">val_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">training_job</span><span class="o">.</span><span class="n">val_set_filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">val_labels</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">test_labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">training_job</span><span class="o">.</span><span class="n">test_set_filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">test_labels</span>

    <span class="k">if</span> <span class="n">training_job</span><span class="o">.</span><span class="n">save_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Default save dir to models subdir of training labels.</span>
        <span class="n">training_job</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">labels_train_path</span><span class="p">),</span> <span class="s2">&quot;models&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">run_name</span><span class="p">:</span>
        <span class="n">training_job</span><span class="o">.</span><span class="n">run_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">run_name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prefixes</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">training_job</span><span class="o">.</span><span class="n">run_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Add run name specified in file to prefixes.</span>
            <span class="n">prefixes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_name</span><span class="p">)</span>

        <span class="c1"># Create new run name.</span>
        <span class="n">training_job</span><span class="o">.</span><span class="n">run_name</span> <span class="o">=</span> <span class="n">training_job</span><span class="o">.</span><span class="n">new_run_name</span><span class="p">(</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefixes</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">suffix</span><span class="p">,</span> <span class="n">check_existing</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="c1"># Print path to training job run.</span>

    <span class="c1"># NOTE: This must be first line printed to stdout, otherwise we won&#39;t be</span>
    <span class="c1"># able to access it when running training in subprocess via Popen.</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">training_job</span><span class="o">.</span><span class="n">run_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training labels file: </span><span class="si">{labels_train_path}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training profile: </span><span class="si">{job_filename}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Log configuration to console.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Arguments:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training job:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">TrainingJob</span><span class="o">.</span><span class="n">_to_dicts</span><span class="p">(</span><span class="n">training_job</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initializing training...&quot;</span><span class="p">)</span>
    <span class="c1"># Create a trainer and run!</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
        <span class="n">training_job</span><span class="p">,</span> <span class="n">tensorboard</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">,</span> <span class="n">zmq</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">zmq</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">trained_model</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">SLEAP</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial-part2.html">Tutorial, Part 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference.html">Feature Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Murthy Lab @ Princeton.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>