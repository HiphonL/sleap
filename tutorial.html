

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorial &mdash; LEAP  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Skeleton" href="skeleton.html" />
    <link rel="prev" title="Social LEAP Estimates Animal Pose (sLEAP)" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> LEAP
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">sLEAP Package</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#stage-1-creating-a-project">Stage 1: Creating a project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#opening-a-video">Opening a video</a></li>
<li class="toctree-l3"><a class="reference internal" href="#creating-the-skeleton">Creating the Skeleton</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#stage-2-labeling-and-learning">Stage 2: Labeling and learning</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#labeling-the-first-frame">Labeling the first frame</a></li>
<li class="toctree-l3"><a class="reference internal" href="#saving">Saving</a></li>
<li class="toctree-l3"><a class="reference internal" href="#labeling-more-frames">Labeling more frames</a></li>
<li class="toctree-l3"><a class="reference internal" href="#active-learning">Active learning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reviewing-and-fixing-predictions">Reviewing and fixing predictions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#stage-3-tracking-instances-across-frames">Stage 3: Tracking instances across frames</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#track-proofreading">Track proofreading</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="skeleton.html">Skeleton</a></li>
<li class="toctree-l1"><a class="reference internal" href="video.html">Video</a></li>
<li class="toctree-l1"><a class="reference internal" href="instance.html">Instance</a></li>
<li class="toctree-l1"><a class="reference internal" href="dataset.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="inference.html">Inference</a></li>
<li class="toctree-l1"><a class="reference internal" href="gui.html">GUI</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LEAP</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>Before you can use sLEAP, you’ll need to install it. Follow the
instructions at <a class="reference internal" href="index.html#installation"><span class="std std-ref">Installation</span></a> to install sLEAP and
start the GUI app.</p>
<p>There are three main stages of using sLEAP:</p>
<ol class="arabic simple">
<li><p>Creating a project, opening a movie and defining the skeleton;</p></li>
<li><p>Labeling and learning, labeling of video frames assisted by network
predictions;</p></li>
<li><p>Prediction and proofreading, final network predictions of body-part
positions and proofreading of track identities in full videos.</p></li>
</ol>
<div class="section" id="stage-1-creating-a-project">
<h2>Stage 1: Creating a project<a class="headerlink" href="#stage-1-creating-a-project" title="Permalink to this headline">¶</a></h2>
<p>When you first start sLEAP you’ll see an open dialog. Since you don’t
yet have a project to open, click “Cancel” and you’ll be left with a
new, empty project.</p>
<div class="section" id="opening-a-video">
<h3>Opening a video<a class="headerlink" href="#opening-a-video" title="Permalink to this headline">¶</a></h3>
<p>Add a <strong>video</strong> by clicking the “Add Video” button in the “Videos” panel
on the right side of the main window, the “Add Video” command in the
“Videos” menu, or the keyboard shortcut.</p>
<p><img alt="image0" src="docs/_static/add-video.gif" /></p>
<p>You’ll then be able to select one or more video files and click “Open”.
sLEAP currently supports mp4, avi, and h5 files. For mp4 and avi files,
you’ll be asked whether to import the video as grayscale. For h5 files,
you’ll be asked the dataset and whether the video is stored with
channels first or last.</p>
<p><img alt="image1" src="docs/_static/video-options.gif" /></p>
</div>
<div class="section" id="creating-the-skeleton">
<h3>Creating the Skeleton<a class="headerlink" href="#creating-the-skeleton" title="Permalink to this headline">¶</a></h3>
<p>Create a new <strong>skeleton</strong> using the “Skeleton” panel on the right side
of the main window.</p>
<p>Use the “New node” button to add a node (i.e., joint or body part).
Double click the node name to rename it (hit enter after you type the
new name). Repeat until you have created all your nodes. You then need
to connect the nodes with edges. Directly to the left of the “Add edge”
button you’ll see two drop-down menus. Use these to select a pair of
nodes, and then click “Add edge”. Repeat until you’ve entered all the
edges.</p>
<p><img alt="image2" src="docs/_static/add-skeleton.gif" /></p>
<p>Note: it’s okay to add edges after you’ve already labeled some
instances. Any labeled instances will be updated with the new edge. But
if you add a new node after labeling instances, there’s currently no way
to update your already labeled instances with this node.</p>
</div>
</div>
<div class="section" id="stage-2-labeling-and-learning">
<h2>Stage 2: Labeling and learning<a class="headerlink" href="#stage-2-labeling-and-learning" title="Permalink to this headline">¶</a></h2>
<p>We start by assembling a candidate group of images to label. You can
either pick your own frames or let the system suggest a set of frames
using the “Generate Suggestions” panel. sLEAP can choose these frames
(i) randomly, or using (ii) Strides (evenly spaced samples), (iii) PCA
(runs Principle Component Analysis on the images, clusters the images
into groups, and uses sample frames from each cluster), or (iv) BRISK
(extracts features from each image using key-point detection then runs
PCA and clustering).</p>
<p><img alt="image3" src="docs/_static/suggestions.jpg" /></p>
<div class="section" id="labeling-the-first-frame">
<h3>Labeling the first frame<a class="headerlink" href="#labeling-the-first-frame" title="Permalink to this headline">¶</a></h3>
<p>Start by adding an <strong>instance</strong> of the skeleton to the current image by
clicking the “Add Instance” button in the Instances panel, selecting
“Add Instance” from the “Labels” menu, or the keyboard shortcut. This
first instance will have its points located at random. Move the points
to their appropriate positions by dragging with the mouse. Use the mouse
scroll-wheel to <strong>zoom</strong>.</p>
<p><img alt="image4" src="docs/_static/labeling.gif" /></p>
<p>You can <strong>move the entire instance</strong> by holding down the “Alt” key while
you click and drag the instance. You can <strong>rotate the instance</strong> by
using the scroll-wheel while holding down the “Alt” key.</p>
<p>For body parts that are not visible in the frame, right-click the node
(or its name) to toggle visibility. The node will appear smaller to show
that it’s marked as “not visible”. If you can determine where an
occluded node would be in the image, you may label it as “visible” in
order to train the model to predict the node even when it’s occluded.</p>
<p><img alt="image5" src="docs/_static/toggle-visibility.gif" /></p>
</div>
<div class="section" id="saving">
<h3>Saving<a class="headerlink" href="#saving" title="Permalink to this headline">¶</a></h3>
<p>Since this is a new project, you’ll need to select a location and name
the first time you save. sLEAP will ask you to save before closing any
project that has been changed to avoid losing any work. Note: There is
not yet an “undo” feature built into sLEAP. If you want to make
temporary changes to a project, use the “Save As…” command first to save
a copy of your project.</p>
</div>
<div class="section" id="labeling-more-frames">
<h3>Labeling more frames<a class="headerlink" href="#labeling-more-frames" title="Permalink to this headline">¶</a></h3>
<p>After labeling the first frame saving the project, it’s time to label
more frames. Nodes positions will be copied from the instances in the
prior labeled frame to increase labeling speed. If you generated a list
of suggested frames, you can go to the next frame in the labeling set by
either:</p>
<ul class="simple">
<li><p>clicking “Next” under the list of suggested frames</p></li>
<li><p>double-clicking one of the suggested frames on the list</p></li>
<li><p>selecting “Next Suggestion” from the “Labels” menu</p></li>
<li><p>using the keyboard shortcut listed in the “Labels” menu</p></li>
</ul>
<p>You can also always pick a frame to label by using the slider bar under
the video.</p>
<p>There’s no need to be consistent about which animal you label with which
instance for the case of multiple animals. For instance, suppose you
have a male and a female. It’s fine to label the male with the blue
instance in some frames and the orange instance in others. Tracking (and
track proofreading) is the final stage in the workflow and occurs after
predicting body part locations.</p>
<p>When you label a frame, it’s best if you can label all the instances of
your animal in the frame. Otherwise, the models may learn to not
identify things that look like the instances you didn’t label.</p>
</div>
<div class="section" id="active-learning">
<h3>Active learning<a class="headerlink" href="#active-learning" title="Permalink to this headline">¶</a></h3>
<p>Active learning has two main goals. First, it speeds up the labeling
process as it is faster to correct a predicted instance which is mostly
correct than it is to add a new instance from scratch. Second, it
provides feedback about where your model does well and where it does
poorly, and this should give you a better idea of which frames will be
most useful to label.</p>
<p>To run active learning, select “Run Active Learning…” from the “Predict”
menu. This trains new models using the frames that you’ve already
labeled in your project, and then uses these models to predict instances
in the suggested frames that you haven’t yet labeled (or on other random
frames). This process can take a while, and since it runs on your
machine, you should only try it if you have a GPU installed.</p>
<p><img alt="image6" src="docs/_static/learning-dialog.jpg" /></p>
<p>Active learning uses the training settings which we’ve found to work
well on a wide range of videos. We train a “centroid” model on 1/4 scale
images and then use this to crop where we think there are instances
during inference. Another pair of models are trained on unscaled,
cropped images. The “confidence map” model is used to infer node
locations, and the “part affinity field” model is used to infer the
edges that connect nodes.</p>
<p>There are a few hyperparameters that you can control for active
learning:</p>
<ul class="simple">
<li><p><strong>Minimum crop size</strong> ensures that the box for our crop is at least a
given size instead of using the tightest crop that will bound any
labeled instance.</p></li>
<li><p><strong>Negative samples</strong> help the model learn to distinguish instances
from the background by including randomly selected crops where there
are no labeled instances.</p></li>
<li><p><strong>Sigma</strong> controls the size of the confidence map gaussians and part
affinity fields used for training.</p></li>
<li><p><strong>Batch Size</strong> determines how many samples are used to train the
neural network at one time. If you get an error that your GPU ran out
of memory while training, you should try a smaller batch size.</p></li>
</ul>
<p>You can visually preview the effects of these settings on the training
data by clicking the “View Training Image Inputs…” button. You’ll then
see windows with the confidence maps and part affinity fields that will
be used to train the models.</p>
<p>After setting the parameters click “Run Active Learning”. During the
training process, you’ll see a window where you can monitor the loss.
Blue points are training loss for each batch, lines are training and
validation loss for the epochs (these won’t appear until the second
epoch has finished.) There’s a button to stop training the model when
you think is appropriate, or the training will automatically stop if the
model doesn’t improve for a certain number of epochs (15 by default)</p>
<p>First we train a model for confidence maps, part affinity fields, and
centroids, and then we run inference. The GUI doesn’t yet give you a way
to monitor the progress during inference, although you can get more
information in the console window from which you started sLEAP.</p>
<p>When active learning finishes, you’ll be told how many instances were
predicted. Suggested frames with predicted instances will be marked in
red on the seek-bar.</p>
<p><strong>For experts in training neural networks:</strong> The “Expert Controls…”
command in the “Predict” lets you control many more hyperparameters, as
well as defining “training profiles”. You can turn off cropping for
training or for inference, and you can adjust image scaling. You can
also mix and match models trained at different times. Use at your own
risk.</p>
<p><img alt="image7" src="docs/_static/expert-dialog.jpg" /></p>
</div>
<div class="section" id="reviewing-and-fixing-predictions">
<h3>Reviewing and fixing predictions<a class="headerlink" href="#reviewing-and-fixing-predictions" title="Permalink to this headline">¶</a></h3>
<p>After you’ve successfully trained models and predicted some instances,
you’ll get a message that active learning has finished. Every suggested
frame with predicted instances will have a distinctive mark in the
seek-bar. Suggested frames which you labeled are marked in blue while
those with predicted instances are marked in red. Predicted instances
will <em>not</em> be used for future model training unless you correct the
predictions in the GUI.</p>
<p><img alt="imagefix" src="docs/_static/fixing-predictions.gif" /></p>
<p>Predicted instances in the frame are displayed in grey with yellow
nodes. To edit a prediction, you’ll need to replace it with an editable
instance. There are a few ways to do this:</p>
<ul class="simple">
<li><p>double-click the predicted instance and it will be converted into a
regular instance</p></li>
<li><p>add an instance (by clicking the “Add Instance” button, using the
menu command or keyboard shortcut) and it will replace one of the
predicted instances with your new instance (it does this in sequence,
so the next instance you add will replace a different predicted
instance in the frame)</p></li>
</ul>
<p>You can now edit the instance as before. Once you’ve added and/or
corrected more instances, you can repeat the active learning process:
train a new model, predict on more frames, correct those predictions,
and so on. You’ll want to regularly generate new frame suggestions,
since active learning will return predictions for just these frames.</p>
</div>
</div>
<div class="section" id="stage-3-tracking-instances-across-frames">
<h2>Stage 3: Tracking instances across frames<a class="headerlink" href="#stage-3-tracking-instances-across-frames" title="Permalink to this headline">¶</a></h2>
<p>When you’re satisfied with the predictions you’re getting during active
learning, you can use your models to predict on more frames by selecting
“Run Inference…” from the “Predict” menu. This will use the most
recently trained set of models.</p>
<p><img alt="image8" src="docs/_static/inference-dialog.jpg" /></p>
<p>Inference only returns track data if you run it on a continuous range of
frames. To do this, select a range of frames in the seek-bar by
shift-clicking in the seek-bar and dragging over the desired range (this
could be the entire video). The selected frames will be highlighted in
light blue in the seek-bar. If a range of frames is selected in the
seek-bar, inference will return predictions (with tracks) for that
range, rather than returning predictions on the suggested frames.</p>
<p>It’s also possible to run inference using the command line interface
(useful if you’re going to run on a cluster). For more details on the
command line interface, run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">sleap</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">inference</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
<div class="section" id="track-proofreading">
<h3>Track proofreading<a class="headerlink" href="#track-proofreading" title="Permalink to this headline">¶</a></h3>
<p>Once you have predicted tracks, you’ll need to proofread these to ensure
that the identities of instances across frames are correct. By default,
predicted instances all appear in grey and yellow. Select “Color
Predicted Instances” to show the tracks in color. (Note that colors in
the frame match colors in the seek-bar and colors in the “Instances”
panel.) Click an instance to see it’s track name. Double-click the track
name in the “Instances” panel to change the name.</p>
<p>There are two main types of mistakes made by the tracking code: mistaken
identities and lost identities.</p>
<p><strong>Mistaken Identities:</strong> The code may misidentify which instance goes in
which track, in which case you’ll want to “swap” the identities.</p>
<p>You can swap the identities assigned to a pair of instances by selecting
“Transpose Instance Tracks” in the “Labels” menu. If there are just two
instances in the frame, it already knows what it do. If there are more,
you’ll have to click the two instances you want to swap.</p>
<p><img alt="image9" src="docs/_static/fixing-track.gif" /></p>
<p>You can assign an instance to a different (or new) track from the “Set
Instance Track” submenu in the “Labels” menu.</p>
<p>You can select instances by typing a number between 1 and 9, by clicking
the instance in the frame, or by clicking the instance in the
“Instances” panel (on the right side of your main window). When an
instance is selected, you’ll see its track name. These track names can
be edited by double-clicking the track name in the “Instances” panel.</p>
<p>When you assign an instance to a track, this change will also be applied
to all <em>subsequent</em> frames. For instance, if you move an instance from
track 3 to track 2, then any instance in track 3 in subsequent frames
will also be moved to track 2. This lets you effectively “merge” tracks.</p>
<p><strong>Lost Identities:</strong> The code may fail to identity an instance in one
frame with any instances from previous frames. In this case, you’ll want
to find the first frame in which the new track occurs and change the
instance track to the track from previous frames. The “Next Track Spawn
Frame” command in the “Labels” menu will take you to the next frame in
which a new track is spawned.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="skeleton.html" class="btn btn-neutral float-right" title="Skeleton" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Social LEAP Estimates Animal Pose (sLEAP)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Murthy Lab @ Princeton

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>